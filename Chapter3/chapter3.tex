\chapter{Spherical Harmonic Variational Gaussian Processes}

\begin{enumerate}
    \item Related work: Variational Fourier Features
    \item Zonal kernels
    \begin{enumerate}
        \item Examples
        \item Decomposition in spherical harmonics
        \item Laplace Beltrami operator and Zonal kernel operator commute (this is why they share the same eigenfeatures)
    \end{enumerate}
    \item How to compute the Spherical Harmonics: greedy algorithm
    \item Experiments
\end{enumerate}


\section{Spherical Harmonics}

Spherical harmonics are a special set of functions defined on the hypersphere and play a central role in harmonic analysis and approximation theory \citep{wendland2005}. They originate from solving Laplace's equation, and form a complete set of orthogonal functions. Any sufficiently regular function defined on the sphere can be written as a sum of these spherical harmonics, similar to the Fourier series with sines and cosines. Spherical harmonics are defined in arbitrary dimensions \citep{frye2014,dai2013}, but lack practical implementations in dimensions larger than three. This is mainly due to the complexity of solving Laplace's equation in higher dimensions.

In this section, we propose a novel algorithm to construct spherical harmonics in $d$ dimensions. The algorithm is based on the existence of a fundamental system of points which we select in a greedy fashion. The result are spherical harmonics that are a linear combination of zonal functions and form an orth-normal basis on $\dsphere$. The algorithm lends itself well for a practical implementation in Python and TensorFlow, which we provide at: \url{https://github.com/vdutor/SphericalHarmonics}. The code is accompagnied by a series of tests that show the properties of the functions, as detailed below. Before outlining the algorithm in XXX we briefly define spherical harmonics in $\Reals^d$. We refer the interested reader to \citet{dai2013,frye2014} for a comprehensive review.
% exist bases of spherical harmonics consisting of entirely zonal harmonics

We adopt the usual $L_2$ inner product for functions $f: \dsphere \rightarrow \Reals$ and $g: \dsphere \rightarrow \Reals$ restricted to the sphere 
\begin{equation}
     \langle f, g\rangle_{L_{2}(\dsphere)} = \frac{1}{\darea} \int_{\dsphere} f(x)\,g(x) \, \calcd{\omega},
\end{equation}
where $\calcd{\omega(x)}$ is the surface area measure such that $\darea$ denotes the surface area of $\dsphere$ 
\begin{equation}
\label{eq:surface}
    \darea = \int_{\dsphere} \calcd{\omega(x)} = \frac{2 \pi ^ {d/2}}{\Gamma(d/2)}.
\end{equation}

For $x = (x_1, \ldots, x_d) \in \Reals^d$ and $\alpha = (\alpha_1, \ldots, \alpha_d) \in \Naturals^d$, a monomial $x^\alpha$ is a product $x^\alpha = x_1^{\alpha_1} \ldots x_d^{\alpha_d}$, which has degree $|\alpha| = \alpha_1 + \ldots \alpha_d$. A real homogeneous polynomial $P(x)$ of degree $n$ is a linear combination of monomials of degree $n$ with real coefficients, that is $P(x) = \sum_{|\alpha| = n} c_{\alpha} x^{\alpha}$, with $c_\alpha \in \Reals$. We denote $\mathcal{P}_n^d$ as the space of real homogeneous polynomials of degree $n$, and can show that, counting the cardinality of the set $\{\alpha \in \Naturals^d: |\alpha| = n\}$, that $\dim(\mathcal{P}_n^d) = \binom{n + d -1}{n}$. A function $f:\Reals^d \rightarrow \Reals$ is said to be \emph{harmonic} if $\Delta f = 0$, where $\Delta = \partial_{x_1}^2 + \ldots + \partial_{x_d}^2$ and $\partial_{x_i}$ the partial derivate w.r.t. the $i$-th variable.

\begin{definition}
    The spherical harmonics of degree $n$ of $d$ variables, denoted by $\mathcal{H}_{n}^d$, is the linear space of harmonic and homogeneous in degree $n$ polynomials on $\dsphere$, that is 
    \begin{equation}
        \mathcal{H}_{n}^d = \{p \in \mathcal{P}_n^d: \Delta p = 0\ \text{and}\ p: \dsphere \rightarrow \Reals \}.
    \end{equation}
The dimensionality of $ \mathcal{H}_{n}^d$ is given by
\begin{equation}
\label{eq:numharmonics}
\dim(\mathcal{H}_{n}^d) = \frac{2 n + d - 2}{n} \binom{n + d - 3}{d - 1} := \dnumharmonicsforlevel.
\end{equation}
\end{definition}

The space $\mathcal{H}_{n}^d$ has an orthonormal basis consisting of $\dnumharmonicsforlevel$ functions, denoted by $\{\phi_{n,j}\}_{j=1}^{\dnumharmonicsforlevel}$. This implies that
\begin{equation}
    \mathcal{H}_{n}^d  = \textrm{span}\left(\phi_{n,1}, \ldots, \phi_{n, \dnumharmonicsforlevel}\right),\quad\text{and}\quad\left\langle \phi_{n, j}, \phi_{n', j'}\right\rangle_{L_2(\dsphere)} = \delta_{n n'} \delta_{j j'}.
\end{equation}

From the completeness and orthonormality of the spherical harmonic basis $\{\phi_{n,j}\}_{n=0,j=1}^{\infty,\dnumharmonicsforlevel}$, it can be shown that they also form a basis of square-integrable functions \citep{frye2014}. This means that we can decompose a function $f: \dsphere \rightarrow \Reals$ as
\begin{equation}
    f = \sum_{n=0}^{\infty} \sum_{j=1}^{\dnumharmonicsforlevel} \widehat{f}_{n, j} \phi_{n, j},\quad\text{with}\quad\widehat{f}_{n, j} = \langle f, \phi_{n, j} \rangle_{L_2(\dsphere)},
\end{equation}
which can be seen as the spherical analogue of the Fourier decomposition of periodic functions onto a basis of sines and cosines. TODO: discuss uniqueness: any rotations is also a basis.

Subsequently, we will coin the set $\{\phi_{n,j}\}$ as the spherical harmonics. They are indexed by $n$ and $j$, where $n=0,1,2,\ldots$ denotes the degree (or level) and $j=1,\cdots,\dnumharmonicsforlevel$ denotes the orientation of the spherical harmonic. We are interested in finding $\{\phi_{n,j}\}$ in arbitrary dimension. For $d=2$, is solving Laplace's equation ($\Delta p = 0$) directly relatively straightforward. Doing so reveals that $N^{2}_0 = 1$ with $\phi_{0, 1} = 1$ and $N^{2}_n = 2$ for all $n > 0$ with $\phi_{n, 1}(\theta) = \sqrt{2} \cos(n \theta)$ and $\phi_{n, 2}(\theta) = \sqrt{2} \sin(n \theta)$. This shows that on the unit circle $\sphere^1$, the spherical harmonics correspond to the Fourier basis. For $d=3$, we can also directly solve Laplace's diffential equation to find $\dnumharmonicsforlevel = 2n + 1$ and a closed form solution for $\{\phi_{n,j}\}$. However, for $d > 3$, explicit formulations for the spherical harmonics become very rare. To the best of our knowledge, the only explicit formulation we could find is in \citet[Theorem~5.1]{dai2013}, which consists of a product over polynomials. This makes the implementation and its derivate numerically unstable, and only practically useful up to 10 dimensions \citep{Dutordoir2020spherical}. To present our algorithm we first need to cover a few more properties of spherical harmonics.

\begin{theorem}[Addition]
    \label{theorem:addition}
    Let $\{\phi_{n,j}\}_{j=1}^{\dnumharmonicsforlevel}$ be an orthonormal basis for the spherical harmonics of degree $n$ and $x,x' \in \dsphere$. Then the Gegenbauer polynomial $C_n^{(\alpha)}: [-1, 1] \rightarrow \Reals$ of degree $n$ can be written as
\begin{equation}
    \sum_{j=1}^{\dnumharmonicsforlevel} \phi_{n, j}(x) \phi _{n, j}(x') = \frac{n + \alpha}{\alpha}\,
    C_n^{(\alpha)}(x\transpose x')\quad\text{with}\quad \alpha = \frac{d-2}{2}.
\end{equation}
\end{theorem}
As a result of the relation between the Gegenbauer polynomial and the spherical harmonics, are the Gegenbauer polynomial sometimes referred to as ultraspherical polynomials. For $d=2$, Theorem~1 recovers the addition formula of the cosine function, as indeed $\cos(\theta) \cos(\theta') + \sin(\theta) \sin(\theta') = \cos(\theta - \theta')$ and $C_n^{(0)}(t) = \cos(n \arccos(t))$. The Gegenbauer polynomials with $\alpha=0$ are better known as the Chebyshev polynomials. Another connection between spherical harmonics and Gegenbauer polynomials is given by the Funk-Hecke theorem and applies to zonal functions. A zonal function on $\dsphere$ is a function that is rotationally invariant w.r.t. to a vector $\eta \in \dsphere$. This means that the function only depends on the inner product $\eta\transpose x$.

\begin{theorem}[Funk-Hecke]
    % \label{appendix:theorem:funk}
    Let $f$ be an integrable function such that $\int_{-1}^1 \| f(t)\| (1 - t^2)^{(d-3)/2} \calcd{t}$ is finite and $d \ge 2$. Then for every $\phi_{n,j}$ 
    \begin{equation}
        \frac{1}{\darea} \int_{\dsphere} f(x\transpose x')\,\phi_{n, j}(x')\, \calcd{\omega(x')} = {\lambda}_{n}\,\phi_{n,j}(x),
    \end{equation}
    where ${\lambda}_{n}$ is a constant defined by
    \begin{equation}
        \lambda_{n}  = 
        % \frac{\Omega_{d-2}}{\Omega_{d-1}} 
        \frac{\omega_{d}}{C_n^{(\alpha)}(1)} \int_{-1}^1 f(t)\,C_n^{(\alpha)}(t)\,(1 - t^2)^{\frac{d-3}{2}} \calcd{t},
    \end{equation}
    with $\alpha = \frac{d-2}{2}$ and $\omega_d = \frac{\Omega_{d-2}}{\Omega_{d-1}}$.
\end{theorem}
Zonal function?

In light of the close connection between spherical harmonics and Gegenbauer polynomials 


Construct a basis for spherical harmonics $\mathcal{H}_n^d$ that consists of a linear combination of zonal functions 

\begin{definition}[Fundamental System]
    A collection of points $\{\eta_1, \ldots, \eta_N \} \in \dsphere$ is called a fundamental system of degree $n$ on the sphere if
    \begin{equation}
        \textrm{det}\left({\left[C_n^{(\alpha)}(\eta_i\transpose\eta_j)\right]_{i,j=1}^N}\right) > 0,\qquad
        {\left[C_n^{(\alpha)}(\eta_i\transpose\eta_j)\right]_{i,j=1}^N} = 
        \begin{bmatrix}
            C_n^{(\alpha)}(1) & \ldots & C_n^{(\alpha)}(\eta_1\transpose\eta_N) \\
            \vdots & & \vdots \\
            C_n^{(\alpha)}(\eta_N\transpose\eta_1) & \ldots & C_n^{(\alpha)}(1)
        \end{bmatrix}
    \end{equation}
\end{definition}

\begin{lemma}
    There exists a fundamental system of degree $n$ on the sphere.
\end{lemma}


\begin{theorem}
    If $\{\eta_1, \ldots, \eta_N \} \in \dsphere$ is a fundamental system of points on the sphere, then $\{C_n^{(\alpha)}(\eta_i \cdot)\}_{i=1}^N$ is a basis for $\mathcal{H}_n^d$.
\end{theorem}

Orth-normal basis using Gram-Schmidt.

\subsection{How do we construct a fundamental system of points?}

\begin{equation}
    \renewcommand\arraystretch{1.3}
    \MC_n^{(\alpha)}(\veta, \eta_{*}) =
    \left[
        \begin{array}{c|c}
          C_n^{(\alpha)}(\veta\veta\transpose) \in \Reals^{M \times M} & C_n^{(\alpha)}(\veta\eta_{*}\transpose) \in \Reals^{M \times 1} \\
          \hline
          C_n^{(\alpha)}(\veta\eta_{*}\transpose)\transpose \in \Reals^{1 \times M} & C_n^{(\alpha)}(1) \in \Reals
        \end{array}
    \right]
\end{equation}

Determinant using Schur complement
\begin{equation}
    % \mathcal{L}(\eta_{*}) = 
    \textrm{det}(\MC_n^{(\alpha)}(\veta, \eta_{*})) = \textrm{det}(C_n^{(\alpha)}(\veta\veta\transpose))\,\left(C_n^{(\alpha)}(1) - C_n^{(\alpha)}(\eta_{*}\veta\transpose) \left[C_n^{(\alpha)}(\veta\veta\transpose)\right]^{-1} C_n^{(\alpha)}(\veta\eta_{*}\transpose) \right)
\end{equation}

\begin{align}
    \eta &= \argmax_{\eta_* \in \dsphere}\ \textrm{det}(\MC_n^{(\alpha)}(\veta, \eta_{*})) \\
    &= \argmin_{\eta_* \in \Reals^d}\ C_n^{(\alpha)}(\frac{\eta_{*}}{\norm{\eta_*}}\veta\transpose) \left[C_n^{(\alpha)}(\veta\veta\transpose)\right]^{-1} C_n^{(\alpha)}(\veta\frac{\eta_{*}\transpose}{\norm{\eta_*}})
\end{align}


% \begin{theorem}[Addition]
% \label{appendix:theorem:addition}
% Between the spherical harmonics of degree $n$ in dimension $d$ and the Gegenbauer polynomials of degree $n$ there exists the relation
% \begin{equation}
%     \sum_{j=1}^{\dnumharmonicsforlevel} \sh_{n, j}(\vx) \sh_{n, j}(\vx') = \frac{n + \alpha}{\alpha}\,
%     C_n^{(\alpha)}(\vx\transpose\vx'),
% \end{equation}
% with $\alpha = \frac{d-2}{2}$.
% \end{theorem}


% From the completeness and orthonormality of the spherical harmonic basis, it can be shown that they also form a basis of square-integrable functions $f: \dsphere \rightarrow \Reals$, which means
% \begin{equation}
%     f = \sum_{n=0}^{\infty} \sum_{j=1}^{\dnumharmonicsforlevel} \widehat{f}_{n, j} \sh_{n, j},\ \text{with}\ \widehat{f}_{n, j} = \langle f,  \sh_{n, j} \rangle_{L_2(\dsphere)}.
% \end{equation}
% Which can be seen as the spherical analogue of the Fourier decomposition of a periodic function in $\Reals$ onto a basis of sines and cosines.

% % \begin{theorem}
% % \label{appendix:theorem:eigenvalues}
% % The spherical harmonics are the eigenfunctions of the Laplace-Beltrami operator with eigenvalues $- n (n + d - 2)$ so that
% % \begin{equation}
% %     \Delta^{\dsphere} \phi_{n, j} = - n (n + d - 2) \phi_{n, j}.
% % \end{equation}
% % \end{theorem}

% \subsection{Gegenbauer polynomials}

% Gegenbauer polynomials $C_n^{(\alpha)}: [-1, 1] \rightarrow \Reals$ are orthogonal polynomials with respect to the weight function $(1 - z^2)^{\alpha - 1/2}$.
% A variety of characterizations of the Gegenbauer polynomials are available. We use, both, the polynomial characterisation for its numerical stability
% \begin{equation}
% \label{appendix:eq:gegenbauer}
%     C_{n}^{({\alpha})}(z)=\sum _{{j=0}}^{{\lfloor n/2\rfloor }}{\frac  {(-1)^{j}\, \Gamma (n-j+\alpha )}{\Gamma (\alpha )\Gamma({j+1})\Gamma{(n-2j + 1)}}}(2z)^{{n-2j}},
% \end{equation}
% and Rodrigues' formulation:
% \begin{equation}
% \label{appendix:eq:gegenbauer-rodrigues}
%    C_{n}^{(\alpha )}(z)={\frac {(-1)^{n}}{2^{n}n!}}{\frac {\Gamma (\alpha +{\frac {1}{2}})\Gamma (n+2\alpha )}{\Gamma (2\alpha )\Gamma (\alpha +n+{\frac {1}{2}})}}(1-z^{2})^{-\alpha +1/2}{\frac {d^{n}}{dz^{n}}}\left[(1-z^{2})^{n+\alpha -1/2}\right].
% \end{equation}
% The polynomials normalise by
% \begin{equation}
% \label{appendix:eq:gegenbauer-normalisation}
%     \int_{-1}^{1}  \left[C_{n}^{({\alpha})}(z)\right]^2  (1 - z^2)^{\alpha - \frac{1}{2}} \calcd{z} = \frac{\Omega_{d-1}}{\Omega_{d-2}} \frac{\alpha}{n + \alpha} C_{n}^{({\alpha})}(1) = \frac{\pi 2^{1 - 2\alpha} \Gamma(n + 2 \alpha)}{n! (n + \alpha) \Gamma(\alpha)^2},
% \end{equation}
% with $C_{n}^{({\alpha})}(1) = \frac{\Gamma(2\alpha + n)}{\Gamma(2 \alpha)\,n!}$. Also note the following relationship $\frac{n + \alpha}{\alpha} C_n^{(\alpha)}(1) = \dnumharmonicsforlevel$.


% There exists a close relationship between Gegenbauer polynomials (also known as \emph{generalized Legendre polynomials}) and spherical harmonics, as we will show in the next theorems. 

% \begin{theorem}[Addition]
% \label{appendix:theorem:addition}
% Between the spherical harmonics of degree $n$ in dimension $d$ and the Gegenbauer polynomials of degree $n$ there exists the relation
% \begin{equation}
%     \sum_{j=1}^{\dnumharmonicsforlevel} \sh_{n, j}(\vx) \sh_{n, j}(\vx') = \frac{n + \alpha}{\alpha}\,
%     C_n^{(\alpha)}(\vx\transpose\vx'),
% \end{equation}
% with $\alpha = \frac{d-2}{2}$.
% \end{theorem}

% As a illustrative example, this property is analogues to the trigonometric addition formula: $\sin(x)\sin(x') + \cos(x)\cos(x') = \cos(x - x')$.

% \begin{theorem}[Funk-Hecke]
% \label{appendix:theorem:funk}
% Let $s(\cdot)$ be an integrable function such that $\int_{-1}^1 \| s(t)\| (1 - t^2)^{(d-3)/2} \calcd{t}$ is finite and $d \ge 2$. Then for every $\sh_{n,j}$ 
% \begin{equation}
%     \frac{1}{\darea} \int_{\dsphere} s(\vx\transpose \vx')\,\sh_{n, j}(\vx')\, \calcd{\omega(\vx')} = {\lambda}_{n}\,\sh_{n,j}(\vx),
% \end{equation}
% where $\widehat{a}_{n}$ is a constant defined by
% \begin{equation}
%     \lambda_{n}  = 
%     % \frac{\Omega_{d-2}}{\Omega_{d-1}} 
%     \frac{\omega_{d}}{C_n^{(\alpha)}(1)} \int_{-1}^1 s(t)\,C_n^{(\alpha)}(t)\,(1 - t^2)^{\frac{d-3}{2}} \calcd{t},
% \end{equation}
% with $\alpha = \frac{d-2}{2}$, $\omega_d = \frac{\Omega_{d-2}}{\Omega_{d-1}} = \frac{\Gamma{(\frac{d}{2}})}{\Gamma(\frac{d-1}{2}) \sqrt{\pi}}$.
% \end{theorem}

% Funk-Hecke simplifies a $(d\!-\!1)$-variate surface integral on $\dsphere$ to a one-dimensional integral over $[-1, 1]$. This theorem gives us a practical way of computing the Fourier coefficients for any zonal kernel. 
